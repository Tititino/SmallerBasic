# SmallerBasic
This repository contains a compiler to LLVM IR of a language inspired by Microsoft's Small Basic.

## Running the program
To run the program per se the only dependencies are gradle and java.
To make the generated LLVM IR executable `clang` is also required.

By running `gradle jar` gradle will create a self-contained and executable jar that can be ran with   
```
$ java -jar <path to jar> <path to file>
```

The repository also comes with a small bash script, called `smallerbasic`, which simplifies the compilation process.
Once the path to the jar and the runtime are specified the script will take as an argument a file: let `<dir>/<file>` be the path to it, the generated artifacts are:
  - `./<file>.ll` the LLVM IR of the file appended to the runtime
  - `./<file>.s` the assembly code generated
  - `./<file>` the executable

## Features
### Control flow
The programmer may use all the classic control flow constructs of structured programming:
if-then-else, while loops, for loops (inclusive and with steps).

### Variables
All variables are global and not typed and can contain one of three kinds of values:
  - numbers (floating point)
  - strings
  - booleans

The user may also define arrays, indexed by numbers.
The arrays can be multidimensional.

### Subroutines and functions
It is not possible to define functions that take arguments per se, but the user may instead define "subroutines" that modify the global state, or use a set of predefined external functions.

As of now the available external functions are:
  - `IO.WriteLine(<value>)`: prints a value on the condition that it is not an array
  - `IO.ReadLine()`: reads a line from `stdin`, with a hard limit of 100 chars
  - `Math.Sin(<var>), Math.Cos(<var>), Math.Sqrt(<var>), Math.Floor(<var>) ...`


## Directory structure
```
src/
|___main/
    |___antlr/smallerbasic/ <- This directory holds the grammar
    |   | SBGrammar.g4
    |___java/smallerbasic/
        |___AST/
        |   |___nodes/ <- AST nodes definitions
        |   |___staticChecks/ <- static checks on the AST (e.g. type checking)
        |   | ParseTreeToASTVisitor.java <- converer from a parse tree to an AST
        |   | ...
        |___compiler/ <- everything related to printing an AST to LLVM IR
        |___symbolTable/ <- everything related to associating names to the entities of the AST
        | App.java <- the main class
        | CompilationUtils.java <- utilities to lex, parse, and compile
        | ... 
```
These are the main classes of the project.
In the folder `examples` there are some example sources.

## The runtime
Files generated by this program need a runtime environment to be compiled and ran.
There should be a copy located in `./app/src/main/resources/runtime.ll`.
Alternatively the single files can be found at [this repository](https://github.com/Tititino/llvm-smallerbasic-runtime)
 and can be built by invoking `make out/runtime.ll`.

## Bugs and problems
  - The main problem as of right now is that the runtime makes use of dynamic allocation, without any kind of garbage collection.
  - A program like
  ```
  While (true)
    IO.WriteLine("Hello, world!")
  EndWhile
  ```
  will segfault after around 500.000 prints.
  This is not due to the previous problem with dynamic allocation, but is because the stack is filled since all calls to external functions allocate a value on the stack to hold the result, even if that particular function doesn't return any value.
  - error reporting doesn't really like tabs
  - copy between arrays and array printing are not supported, so something like 
  ```
  X[0][1] = 2
  Y = X
  ```
  will throw a runtime exception.
  